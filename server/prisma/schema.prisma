// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자 모델
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String? // Google 로그인 시 null 가능
  name      String
  googleId  String?  @unique // Google OAuth ID
  picture   String? // Google 프로필 사진 URL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions            Transaction[]
  categories              Category[]
  budgets                 Budget[]
  salaryCalculations      SalaryCalculation[]
  notes                   Note[]
  folders                 Folder[]
  templates               NoteTemplate[]
  stickyNotes             StickyNote[]
  pomodoroSessions        PomodoroSession[]
  pomodoroSettings        PomodoroSettings?
  userSettings            UserSettings?
  dashboardChecklistItems DashboardChecklistItem[]
  subscriptions           Subscription[]
  refreshSessions         RefreshSession[]

  @@map("users")
}

model RefreshSession {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String   @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime @default(now())
  ipAddress  String?
  userAgent  String?

  @@index([userId])
  @@map("refresh_sessions")
}

// 카테고리 모델
model Category {
  id        String       @id @default(cuid())
  name      String
  type      CategoryType // INCOME or EXPENSE
  color     String?
  icon      String?
  isDefault Boolean      @default(false) // 기본 제공 카테고리
  userId    String?
  user      User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  transactions Transaction[]

  @@map("categories")
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum SpendingType {
  FIXED
  VARIABLE
}

enum TransactionSource {
  MANUAL
  SUBSCRIPTION
}

enum BillingCycle {
  WEEKLY
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum SubscriptionHistoryType {
  PRICE_CHANGE
  STATUS_CHANGE
  BILLING_CYCLE_CHANGE
  NOTE
}

enum LanguageCode {
  ko
  en
  system
}

// 거래 내역 모델
model Transaction {
  id             String            @id @default(cuid())
  amount         Float
  description    String?
  date           DateTime
  type           CategoryType
  spendingType   SpendingType      @default(VARIABLE)
  source         TransactionSource @default(MANUAL)
  externalId     String?
  subscriptionId String?
  categoryId     String
  category       Category          @relation(fields: [categoryId], references: [id])
  subscription   Subscription?     @relation(fields: [subscriptionId], references: [id])
  userId         String
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  noteTransactions NoteTransaction[]

  @@unique([userId, externalId])
  @@index([userId, date])
  @@index([categoryId])
  @@map("transactions")
}

model Subscription {
  id               String                @id @default(cuid())
  userId           String
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  amount           Decimal               @db.Decimal(18, 2)
  currency         String                @default("KRW")
  billingCycle     BillingCycle
  nextBillingDate  DateTime
  paymentMethod    String?
  category         String?
  status           SubscriptionStatus    @default(ACTIVE)
  trialEndDate     DateTime?
  notifyDaysBefore Int?
  notes            String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  transactions     Transaction[]
  histories        SubscriptionHistory[]

  @@index([userId, nextBillingDate])
  @@index([userId, status])
  @@map("subscriptions")
}

model SubscriptionHistory {
  id             String                  @id @default(cuid())
  subscriptionId String
  subscription   Subscription            @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  type           SubscriptionHistoryType
  prevAmount     Decimal?                @db.Decimal(18, 2)
  newAmount      Decimal?                @db.Decimal(18, 2)
  prevCycle      BillingCycle?
  newCycle       BillingCycle?
  prevStatus     SubscriptionStatus?
  newStatus      SubscriptionStatus?
  description    String?
  createdAt      DateTime                @default(now())

  @@index([subscriptionId, createdAt])
  @@map("subscription_histories")
}

// 예산 모델
model Budget {
  id         String   @id @default(cuid())
  categoryId String?
  amount     Float
  month      DateTime // 해당 월 (예: 2024-01-01)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, categoryId, month])
  @@index([userId, month])
  @@map("budgets")
}

// 급여 계산 이력 모델
model SalaryCalculation {
  id              String   @id @default(cuid())
  salaryType      String // 'annual' or 'monthly'
  grossSalary     Float // 세전 급여
  nationalPension Float // 국민연금
  healthInsurance Float // 건강보험
  longTermCare    Float // 장기요양보험
  employmentIns   Float // 고용보험
  incomeTax       Float // 소득세
  localIncomeTax  Float // 지방소득세
  netSalary       Float // 실수령액
  dependents      Int      @default(0) // 부양가족 수
  nonTaxable      Float    @default(0) // 비과세액
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@map("salary_calculations")
}

// 폴더 모델
model Folder {
  id        String   @id @default(cuid())
  name      String
  color     String?
  icon      String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  notes Note[]

  @@index([userId])
  @@index([userId, updatedAt])
  @@index([userId, deletedAt])
  @@map("folders")
}

// 메모 타입 enum
enum NoteType {
  TEXT
  CHECKLIST
  MARKDOWN
  QUICK
}

// 공개 설정 enum
enum NoteVisibility {
  PRIVATE
  PUBLIC
  PROTECTED
}

// 메모 모델
model Note {
  id             String         @id @default(cuid())
  title          String
  content        String         @db.Text
  type           NoteType       @default(TEXT)
  visibility     NoteVisibility @default(PRIVATE)
  password       String? // PROTECTED일 때만 사용
  isPinned       Boolean        @default(false)
  isFavorite     Boolean        @default(false)
  isArchived     Boolean        @default(false)
  deletedAt      DateTime? // 소프트 삭제
  publishedUrl   String?        @unique // 공개 URL
  deviceRevision Int            @default(0) // 디바이스 동기화용
  folderId       String?
  folder         Folder?        @relation(fields: [folderId], references: [id], onDelete: SetNull)
  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  checklistItems   ChecklistItem[]
  attachments      Attachment[]
  noteTransactions NoteTransaction[]

  @@index([userId, createdAt])
  @@index([userId, updatedAt])
  @@index([userId, isPinned])
  @@index([userId, isFavorite])
  @@index([folderId])
  @@index([deletedAt])
  @@map("notes")
}

// 체크리스트 항목 모델
model ChecklistItem {
  id          String   @id @default(cuid())
  content     String
  isCompleted Boolean  @default(false)
  order       Int      @default(0)
  noteId      String
  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([noteId, order])
  @@map("checklist_items")
}

// 메모 템플릿 모델
model NoteTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  content     String   @db.Text
  type        NoteType @default(TEXT)
  isDefault   Boolean  @default(false) // 기본 제공 템플릿
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("note_templates")
}

// 첨부파일 타입 enum
enum AttachmentType {
  IMAGE
  AUDIO
  FILE
}

// 첨부파일 모델
model Attachment {
  id           String         @id @default(cuid())
  fileName     String
  fileSize     Int
  mimeType     String
  type         AttachmentType
  url          String // 저장된 파일 경로 또는 URL
  hash         String? // 파일 해시 (중복 제거용)
  thumbnailUrl String? // 이미지 썸네일
  noteId       String
  note         Note           @relation(fields: [noteId], references: [id], onDelete: Cascade)
  createdAt    DateTime       @default(now())

  @@index([noteId])
  @@index([hash])
  @@map("attachments")
}

// 메모-거래 연결 테이블 (다대다)
model NoteTransaction {
  id            String      @id @default(cuid())
  noteId        String
  note          Note        @relation(fields: [noteId], references: [id], onDelete: Cascade)
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([noteId, transactionId])
  @@index([noteId])
  @@index([transactionId])
  @@map("note_transactions")
}

// 스티커 메모 모델
model StickyNote {
  id        String   @id @default(cuid())
  content   String   @db.Text
  color     String   @default("#FFF9C4") // 배경색
  position  Int      @default(0) // 표시 순서 (0-3)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("sticky_notes")
}

// 대시보드 체크리스트 항목 모델
model DashboardChecklistItem {
  id          String   @id @default(cuid())
  content     String
  isCompleted Boolean  @default(false)
  order       Int      @default(0)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, isCompleted])
  @@index([userId, order])
  @@map("dashboard_checklist_items")
}

// 포모도로 세션 타입 enum
enum PomodoroSessionType {
  FOCUS
  SHORT_BREAK
  LONG_BREAK
}

// 포모도로 세션 기록 모델
model PomodoroSession {
  id          String              @id @default(cuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        PomodoroSessionType // 'FOCUS' | 'SHORT_BREAK' | 'LONG_BREAK'
  duration    Int // 예정 시간 (초)
  completed   Boolean             @default(false) // 완료 여부
  startedAt   DateTime            @default(now())
  completedAt DateTime? // 실제 완료 시간
  taskName    String? // 선택적: 작업 연동
  tags        String[] // 태그 배열
  notes       String?             @db.Text
  createdAt   DateTime            @default(now())

  @@index([userId, startedAt])
  @@map("pomodoro_sessions")
}

// 사용자별 포모도로 설정 모델
model PomodoroSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  focusDuration       Int      @default(1500) // 25분 (초)
  shortBreakDuration  Int      @default(300) // 5분 (초)
  longBreakDuration   Int      @default(900) // 15분 (초)
  longBreakInterval   Int      @default(4) // 몇 번마다 긴 휴식
  autoStartBreak      Boolean  @default(false)
  autoStartFocus      Boolean  @default(false)
  soundEnabled        Boolean  @default(true)
  soundVolume         Int      @default(50) // 0-100
  notificationEnabled Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("pomodoro_settings")
}

model UserSettings {
  id                            String       @id @default(cuid())
  userId                        String       @unique
  user                          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  locale                        String       @default("ko-KR")
  language                      LanguageCode @default(system)
  timezone                      String       @default("Asia/Seoul")
  payday                        Int          @default(1)
  currency                      String       @default("KRW")
  weekStartsOn                  Int          @default(1)
  colorScheme                   String       @default("system")
  sidebarPinned                 Boolean      @default(false)
  widgetDockPosition            String       @default("right")
  widgetAutoClose               Boolean      @default(false)
  timerPresets                  Json         @default("[300000,600000,900000,1800000]")
  timerAutoRepeat               Boolean      @default(false)
  timerPreAlertMs               Int?
  timerNotifications            Boolean      @default(true)
  timerSoundEnabled             Boolean      @default(true)
  pomodoroFocusDuration         Int          @default(1500)
  pomodoroShortBreakDuration    Int          @default(300)
  pomodoroLongBreakDuration     Int          @default(900)
  pomodoroLongBreakInterval     Int          @default(4)
  pomodoroAutoStartBreak        Boolean      @default(false)
  pomodoroAutoStartFocus        Boolean      @default(false)
  pomodoroSoundEnabled          Boolean      @default(true)
  pomodoroSoundVolume           Int          @default(50)
  pomodoroNotificationEnabled   Boolean      @default(true)
  stopwatchDefaultGoalTime      Int?
  stopwatchNotificationsEnabled Boolean      @default(true)
  notifyTransactions            Boolean      @default(true)
  notifyMonthlyReport           Boolean      @default(false)
  notifyChecklist               Boolean      @default(true)
  createdAt                     DateTime     @default(now())
  updatedAt                     DateTime     @updatedAt

  @@map("user_settings")
}
